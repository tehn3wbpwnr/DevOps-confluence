<!DOCTYPE html>
<html>
    <head>
        <title>DevOps / Pipeline &amp; Deployment : Private And Public Keys</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">DevOps / Pipeline &amp; Deployment</a></span>
                            </li>
                                                    <li>
                                <span><a href="1179353439.html">DevOps / Pipeline &amp; Deployment Home</a></span>
                            </li>
                                                    <li>
                                <span><a href="DLX-Server-Documents_1541832718.html">DLX Server Documents</a></span>
                            </li>
                                                    <li>
                                <span><a href="All-about-LTI-Integration_1284603908.html">All about LTI Integration</a></span>
                            </li>
                                                    <li>
                                <span><a href="LTIjs-Library_1329463297.html">LTIjs Library</a></span>
                            </li>
                                                    <li>
                                <span><a href="Authentication_1485406210.html">Authentication</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            DevOps / Pipeline &amp; Deployment : Private And Public Keys
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                            
        
    
        
    
        
        
            Created by <span class='author'> Chris Park</span>, last modified on Dec 09, 2024
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p>: This documentation explains the <strong>private and public keys generation process</strong> in the LTIjs service running on dlx-webhost and dlx-econestoga servers.</p><hr/><h1 id="PrivateAndPublicKeys-Contents">Contents</h1><style type='text/css'>/*<![CDATA[*/
div.rbtoc1748352962928 {padding: 0px;}
div.rbtoc1748352962928 ul {list-style: none;margin-left: 0px;padding-left: ;}
div.rbtoc1748352962928 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1748352962928'>
<ul class='toc-indentation'>
<li><a href='#PrivateAndPublicKeys-Contents'>Contents</a></li>
<li><a href='#PrivateAndPublicKeys-1.Wheretheyareused?'>1. Where they are used?</a></li>
<li><a href='#PrivateAndPublicKeys-2.Howarekeysgenerated?'>2. How are keys generated?</a></li>
<li><a href='#PrivateAndPublicKeys-3.Whenwillthesekeysbegenerated?'>3. When will these keys be generated?</a></li>
</ul>
</div><hr/><h1 id="PrivateAndPublicKeys-1.Wheretheyareused?"><strong>1. Where they are used? </strong></h1><p> These private and public keys are Used for <strong>OAuth2 authentication</strong> and <strong><span style="background-color: rgb(198,237,251);">JWT signing and verification</span></strong>.</p><p> For example, in login process, tool provider(dlx server) uses private key to sign JWT(ltik) and LMS(eConestoga) verify the JWT using public key trough the public key endpoint provided by the tool provider.</p><p>So, we can summarize the useage of keyset like…</p><ul><li><p><strong>Authentication</strong><br/>: The LMS knows that the JWT originated from the tool provider because only the provider's private key could generate the valid signature.</p></li><li><p><strong>Integrity</strong><br/>: The LMS knows the JWT has not been altered because the signature verification would fail if the contents were tampered with.</p></li></ul><p /><hr/><h1 id="PrivateAndPublicKeys-2.Howarekeysgenerated?"><strong>2. How are keys generated?</strong></h1><p> The <strong>private and public keys used are generated by</strong> the <code>generatePlatformKeyPair()</code> method in the <code>Auth.js</code> file, based on the <strong>RSA </strong>algorithm.</p><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20241123-190423.png" width="613" loading="lazy" src="attachments/1485438977/1485406222.png?width=613" data-image-src="attachments/1485438977/1485406222.png" data-height="101" data-width="626" data-unresolved-comment-count="0" data-linked-resource-id="1485406222" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20241123-190423.png" data-base-url="https://varlab-dev.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1485438977" data-linked-resource-container-version="5" data-media-id="c9f8526b-baae-4fcb-b2a1-7708b5a304df" data-media-type="file"></span><div id="expander-1791266105" class="expand-container"><div id="expander-control-1791266105" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">Key Generation Codes</span></div><div id="expander-content-1791266105" class="expand-content"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">const keys = crypto.generateKeyPairSync(&#39;rsa&#39;, {
      modulusLength: 4096,
      publicKeyEncoding: {
        type: &#39;spki&#39;,
        format: &#39;pem&#39;
      },
      privateKeyEncoding: {
        type: &#39;pkcs1&#39;,
        format: &#39;pem&#39;
      }
    });</pre>
</div></div></div></div><p /><p> Once private and public keys are created, they are <strong>encrypted and stored in the database</strong>. A symmetric hash key for the AES-256-CBC algorithm is derived using <strong>ENCRYPTIONKEY</strong>(= secret) and SHA-256.</p><p> An IV (Initialization Vector) is generated and used to encrypt the private and public keys using AES-256-CBC before storing them in the database.</p><p> If we want to use public key for some reason, we need to decrypt the data using <strong>IV </strong>and <strong>ENCRYPTIONKEY</strong>.</p><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="Screenshot 2024-11-18 135549-20241118-185549.png" width="760" loading="lazy" src="attachments/1485438977/1485864963.png?width=760" data-image-src="attachments/1485438977/1485864963.png" data-height="145" data-width="774" data-unresolved-comment-count="0" data-linked-resource-id="1485864963" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="Screenshot 2024-11-18 135549-20241118-185549.png" data-base-url="https://varlab-dev.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1485438977" data-linked-resource-container-version="5" data-media-id="c86d70f1-6391-4cc6-990e-75086dffbc39" data-media-type="file"></span><p /><div id="expander-341703467" class="expand-container"><div id="expander-control-341703467" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">Database Encreypt and Decrypt Algorithm</span></div><div id="expander-content-341703467" class="expand-content"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">/**
   * @description Encrypts data.
   * @param {String} data - Data to be encrypted
   * @param {String} secret - Secret used in the encryption
   */
  async Encrypt(data, secret) {
    const hash = crypto.createHash(&#39;sha256&#39;);
    hash.update(secret);
    const key = hash.digest().slice(0, 32);
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipheriv(&#39;aes-256-cbc&#39;, key, iv);
    let encrypted = cipher.update(data);
    encrypted = Buffer.concat([encrypted, cipher.final()]);
    return {
      iv: iv.toString(&#39;hex&#39;),
      data: encrypted.toString(&#39;hex&#39;)
    };
  }

  /**
   * @description Decrypts data.
   * @param {String} data - Data to be decrypted
   * @param {String} _iv - Encryption iv
   * @param {String} secret - Secret used in the encryption
   */
  async Decrypt(data, _iv, secret) {
    const hash = crypto.createHash(&#39;sha256&#39;);
    hash.update(secret);
    const key = hash.digest().slice(0, 32);
    const iv = Buffer.from(_iv, &#39;hex&#39;);
    const encryptedText = Buffer.from(data, &#39;hex&#39;);
    const decipher = crypto.createDecipheriv(&#39;aes-256-cbc&#39;, Buffer.from(key), iv);
    let decrypted = decipher.update(encryptedText);
    decrypted = Buffer.concat([decrypted, decipher.final()]);
    return decrypted.toString();
  }</pre>
</div></div></div></div><p>Please note that changing the ENCRYPTIONKEY will prevent previously encrypted data from being decrypted correctly.</p><p>The <strong>ENCRYPTIONKEY </strong>is defined in the <code>.env</code> file under the name <code>LTI_KEY</code> and is set during the <code>.setup</code> call in <code>index.js</code>.</p><p /><hr/><h1 id="PrivateAndPublicKeys-3.Whenwillthesekeysbegenerated?"><strong>3. When will these keys be generated?</strong></h1><p><code>generatePlatformKeyPair()</code> is called <code>registerPlatform</code>() method that is called in the <strong>platform registration processes</strong>(Dynamic &amp; Manual Registration).</p><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" alt="image-20241123-190619.png" width="760" loading="lazy" src="attachments/1485438977/1485504523.png?width=760" data-image-src="attachments/1485438977/1485504523.png" data-height="569" data-width="921" data-unresolved-comment-count="0" data-linked-resource-id="1485504523" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20241123-190619.png" data-base-url="https://varlab-dev.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1485438977" data-linked-resource-container-version="5" data-media-id="7efc58a0-3ebd-4a0d-bab9-d440f03aba0a" data-media-type="file"></span><p>Currently, we are using this function in two cases:</p><ul><li><p>index.js for <strong>manual registration </strong></p></li></ul><div id="expander-859139460" class="expand-container"><div id="expander-control-859139460" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">Sample code for register platform usage</span></div><div id="expander-content-859139460" class="expand-content"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">const setup = async () =&gt; {
  await lti.deploy({ port: process.env.PORT });

  /**
   * Register platform
   */

  await lti.registerPlatform({
    url: &quot;https://testconestoga.desire2learn.com&quot;,
    name: &quot;eConestoga&quot;,
    clientId: &quot;71120111-f7b5-4a62-ad06-6e36f0ac5fa0&quot;,
    authenticationEndpoint:
      &quot;https://testconestoga.desire2learn.com/d2l/lti/authenticate&quot;,
    accesstokenEndpoint: &quot;https://auth.brightspace.com/core/connect/token&quot;,
    authConfig: {
      method: &quot;JWK_SET&quot;,
      key: &quot;https://testconestoga.desire2learn.com/d2l/.well-known/jwks&quot;,
    },
  });

};
</pre>
</div></div></div></div><ul><li><p><strong>Dynamic Registration</strong> process</p></li></ul>
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1485438977/1485406211.pdf">ENCRYPTIONKEY2 and Local Data Encrypting Method in LTIjs.pdf</a> (application/pdf)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1485438977/1485406222.png">image-20241123-190423.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1485438977/1485504523.png">image-20241123-190619.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/1485438977/1485864963.png">Screenshot 2024-11-18 135549-20241118-185549.png</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on May 27, 2025 13:36</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
